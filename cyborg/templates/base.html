{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if content.title %}{{content.title}} | {% endif %}CYBORG_ Newsletter</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">

    <!-- FONTS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@0,400;0,700;1,400;1,700&family=Roboto+Flex:opsz,wght@8..144,100..1000&display=swap" rel="stylesheet">
    <!-- /FONTS -->

    {% block robots %}<meta name="robots" content="{% if content.noindex_nofollow %}noindex, nofollow{% else %}max-snippet:-1, max-image-preview:large, max-video-preview:-1{% endif %}"/>{% endblock %}

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Upgrade your humanity.">
    <meta name="twitter:description" content="An exploration of technology and systems and how they interact, dominate, or support our humanity.">
    <meta name="twitter:site" content="@NotDefinedTech">
    <meta name="twitter:image" content="https://cyborgnewsletter.com/static/social/cyborg-subscribe-gen.jpg">
    <meta name="twitter:creator" content="@NotDefinedTech">
    <meta property="og:locale" content="en_US">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Upgrade your humanity.">
    <meta property="og:description" content="An exploration of technology and systems and how they interact, dominate, or support our humanity.">
    <meta property="og:url" content="https://cyborgnewsletter.com/">
    <meta property="og:site_name" content="CYBORG_ Newsletter">
    <meta property="og:image" content="https://cyborgnewsletter.com/static/social/cyborg-subscribe-gen.jpg">
    <meta property="og:image:secure_url" content="https://cyborgnewsletter.com/static/social/cyborg-subscribe-gen.jpg">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">

    {# <!-- FAVICONS --> #}
    <link rel="icon" href="/static/images/brand/favicon/cyborg.ico" sizes="32x32">

    {# <!-- OPEN WEB PROTOCOLS --> #}
    <link rel="alternate" type="application/rss+xml" title="CYBORG_ Newsletter" href="/newsletters/feed/">

    {% block extra_head %}{% endblock %}
</head>
<body class="{% block body_classes %}{% endblock %}">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JGP9HHYEJ7"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-JGP9HHYEJ7');
    </script>

    {% block nav_header %}
        {% include 'partials/navigation/nav-header.html' %}
    {% endblock %}
    
    <main id="main">
        {% block content %}
        {% endblock %}
    </main>
    
    {% block footer %}
    <footer>
        <div class="row">
            <div class="copyright">
                &copy; {% now "Y" %} Not Defined LLC. All rights reserved.
            </div>
            <div class="policies">
                <a href="{% url 'policyDetail' slug='artificial-intelligence' %}">AI Policy</a>
            </div>
        </div>
        <div class="row">
            <div class="attribution">
                Designed, developed, and written with ðŸŒˆ by Jess Brown.
            </div>
        </div>
    </footer>
    {% endblock %}

    {% block search_dialog %}
    {# <!-- After distill, run `docfind public/newsletters/search-data.json public/static/search/` to generate the search doc. You may also need to copy that into the local static on newsletter/static/search, so that local search reflects prod/public. --> #}
    <dialog id="search-modal">
            <div class="modal-header">
                <h2>Search</h2>
                <form method="dialog">
                    <button class="btn btn-close" title="Close">&times;</button>
                </form>
            </div>
            
            <input type="search" id="search-input" placeholder="What are you looking for?" autocomplete="off">
            <div class="modal-body">
                <div id="docfind-results"></div>
            </div>
    </dialog>
    <script defer>
        const searchModal = document.getElementById('search-modal');
        const openBtn = document.getElementById('open-search');
        const searchInput = document.getElementById('search-input');

        // Open modal
        openBtn.addEventListener('click', () => {
            searchModal.showModal();
            // Auto-focus the input when it opens
            searchInput.focus();
        });

        // Optional: Close modal if user clicks outside the content box (on the backdrop)
        searchModal.addEventListener('click', (e) => {
            if (e.target === searchModal) searchModal.close();
        });
    </script>
    {% endblock %}

    {% if user.is_staff and change_url %}
    <a href="{{ change_url }}">
        <div class="admin-tools">
            Edit Page
        </div>
    </a>
    <style>
        .admin-tools {
            background-color: var(--white);
            padding: 1rem;
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            right:0;
            color: var(--black);
            box-shadow: 1px 3px 10px rgba(221, 112, 15, 0.61);
            z-index: 10000;
            border-top-left-radius: 5rem;
            border-bottom-left-radius: 5rem;
        }
    </style>
    {% endif %}


    <script src="{% static 'js/scripts.js' %}" defer></script>

    {# <!-- DOCFIND SEARCH --> #}
    <script type="module">
    import search from '/static/search/docfind.js';

    const input = document.getElementById('search-input');
    const resultsDiv = document.getElementById('docfind-results');

    function escapeHTML(str) {
        if (!str) return "";
        return str.replace(/[&<>"']/g, function(m) {
            return {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            }[m];
        });
    }

    function debounce(func, timeout = 300) {
        let timer;
        return (...args) => {
            clearTimeout(timer);
            timer = setTimeout(() => { func.apply(this, args); }, timeout);
        };
    }

    async function performSearch(query) {
        if (query.length < 2) {
            resultsDiv.innerHTML = '';
            return;
        }

        resultsDiv.innerHTML = '<p>Searching...</p>';

        // The 'search' function returns an array of matching documents
        const results = await search(query);

        if (results.length === 0) {
            resultsDiv.innerHTML = `
                <div class="no-results">
                    <p>No newsletters found matching "<strong>${escapeHTML(query)}</strong>".</p>
                </div>
            `;
            return;
        }
        
        resultsDiv.innerHTML = results.map(res => {
            const safeTitle = escapeHTML(res.title);
            const safeHref = encodeURI(res.href);
            
            // 1. Extract the tags from the body string
            // We split by the "Tags:" prefix you added in Django
            let displayBody = res.body || "";
            let tags = [];
            
            if (displayBody.includes("Tags: ")) {
                const parts = displayBody.split("Tags: ");
                displayBody = parts[0]; // Everything before "Tags:"
                tags = parts[1].split(", "); // Everything after "Tags:", split into an array
            }

            const safeBody = escapeHTML(displayBody.substring(0, 150));

            // 2. Build the Tags HTML
            const tagsHTML = tags.length > 0 
                ? `<div class="result-tags">
                    ${tags.map(tag => `<span class="chip">${escapeHTML(tag)}</span>`).join('')}
                </div>`
                : '';

            return `
                <div class="search-result">
                    <a href="${safeHref}">
                        <h3>${safeTitle}</h3>
                    </a>
                    <p>${safeBody}...</p>
                    ${tagsHTML}
                </div>
            `;
        }).join('');
    }

    const processChange = debounce((e) => performSearch(e.target.value));
    input.addEventListener('input', processChange);
</script>

    {% block extra_scripts %}{% endblock %}
</body>
</html>